name: Backend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend using Bastion (First Time + RDS DB)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_PRIVATE_IP }}
          username: ${{ secrets.BACKEND_USER }}
          key: ${{ secrets.BACKEND_KEY }}

          # Bastion settings
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          
          timeout: 60m
          script_stop: true

          script: |
            set -e
            echo "ğŸš€ FIRST TIME Backend + RDS deployment started (Amazon Linux 2023)"

            # ===== 1. INSTALL SYSTEM DEPENDENCIES - FIXED FOR AL2023 =====
            echo "ğŸ“¦ Installing Amazon Linux 2023 dependencies..."
            sudo dnf makecache
            sudo dnf install -y git python3 python3-pip mariadb105 mysql || echo "âš ï¸ Non-critical packages skipped"
            echo "âœ… Dependencies: git $(git --version), python $(python3 --version)"

            # ===== 2. CLONE REPOSITORY =====
            echo "ğŸ”„ Cloning VaibhavJC/Paytm-fullstack-project..."
            REPO_DIR="/home/ec2-user/Paytm-fullstack-project"
            rm -rf "$REPO_DIR"
            git clone https://github.com/VaibhavJC/Paytm-fullstack-project.git "$REPO_DIR"
            cd "$REPO_DIR/Backend"

            echo "âœ… Backend directory: $(pwd)"
            echo "ğŸ“‚ Files: $(ls -la | head -4)"

            # ===== 3. OPTIONAL RDS DATABASE IMPORT =====
            echo "â˜ï¸  RDS Database setup..."
            if [ -f "paytml.sql" ]; then
              echo "ğŸ“„ Found paytml.sql - testing RDS connection..."
              timeout 10 mysql -h projectdb.c1uy4qas2jj8.ap-south-1.rds.amazonaws.com -u admin -pcloud123 -e "SELECT 1;" 2>/dev/null
              if [ $? -eq 0 ]; then
                echo "ğŸŒ Importing to RDS..."
                mysql -h projectdb.c1uy4qas2jj8.ap-south-1.rds.amazonaws.com -u admin -pcloud123 < paytml.sql
                echo "âœ… RDS import SUCCESS!"
              else
                echo "âš ï¸  RDS connection failed - skipping import"
              fi
            else
              echo "âš ï¸  paytml.sql missing - skipping import"
            fi

            # ===== 4. PYTHON ENVIRONMENT =====
            echo "ğŸ Python setup..."
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet

            # ===== 5. START APPLICATION =====
            echo "â–¶ï¸ Starting rds.py..."
            nohup python rds.py > backend.log 2>&1 < /dev/null &
            sleep 20

            # ===== 6. FINAL VERIFICATION =====
            if pgrep -f "rds.py" > /dev/null 2>&1; then
              PID=$(pgrep -f "rds.py")
              echo "âœ… SUCCESS! Backend PID: $PID"
              echo "ğŸ“‹ Startup logs:"
              tail -15 backend.log || echo "Logs ready soon..."
              echo "ğŸ‰ DEPLOYMENT 100% COMPLETE!"
            else
              echo "âŒ Backend failed to start"
              echo "ğŸ“‹ Check logs:"
              tail -20 backend.log || echo "No logs generated"
              echo "ğŸ” Processes:"
              ps aux | grep python | head -3 || echo "No Python processes"
              exit 1
            fi
