name: Backend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend using Bastion (Amazon Linux 2023 + RDS)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_PRIVATE_IP }}
          username: ${{ secrets.BACKEND_USER }}
          key: ${{ secrets.BACKEND_KEY }}

          # Bastion settings
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          
          timeout: 60m
          script_stop: true

          script: |
            echo "ğŸš€ Amazon Linux 2023 Backend + RDS deployment"
            
            # ===== 1. MINIMAL DEPENDENCIES =====
            echo "ğŸ“¦ Installing AL2023 dependencies..."
            sudo dnf makecache -y
            sudo dnf install -y python3 python3-pip git mariadb105 || true
            
            echo "âœ… Ready: git $(git --version), python $(python3 --version)"

            # ===== 2. CLEAN CLONE =====
            echo "ğŸ”„ Cloning repository..."
            REPO_DIR="/home/ec2-user/Paytm-fullstack-project"
            rm -rf "$REPO_DIR"
            git clone https://github.com/VaibhavJC/Paytm-fullstack-project.git "$REPO_DIR"
            cd "$REPO_DIR/Backend"
            echo "âœ… Backend: $(pwd)"

            # ===== 3. RDS IMPORT (SIMPLIFIED - NO MULTI-LINE) =====
            echo "â˜ï¸  RDS setup..."
            if command -v mysql >/dev/null 2>&1 && [ -f "paytm.sql" ]; then
              echo "ğŸ“„ Found paytm.sql ($(wc -c < paytm.sql) bytes)"
              # SINGLE LINE - NO CONTINUATION CHARACTERS
              timeout 10 mysql -h projectdb.c1uy4qas2jj8.ap-south-1.rds.amazonaws.com -u admin -pcloud123 -e "SELECT 1" >/dev/null 2>&1
              if [ $? -eq 0 ]; then
                echo "ğŸŒ Importing to RDS..."
                mysql -h projectdb.c1uy4qas2jj8.ap-south-1.rds.amazonaws.com -u admin -pcloud123 < paytm.sql
                echo "âœ… RDS imported!"
              else
                echo "âš ï¸ RDS unreachable - skipping import"
              fi
            else
              echo "âš ï¸ Skipping RDS (mysql or paytm.sql missing)"
            fi

            # ===== 4. PYTHON SETUP =====
            echo "ğŸ Python environment..."
            rm -rf venv
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip >/dev/null 2>&1
            pip install -r requirements.txt >/dev/null 2>&1

            # ===== 5. START APP =====
            echo "â–¶ï¸ Starting Flask..."
            pkill -f rds.py || true
            sleep 2
            nohup python rds.py > backend.log 2>&1 < /dev/null &
            sleep 25

            # ===== 6. VERIFY =====
            if pgrep -f "rds.py" >/dev/null 2>&1; then
              PID=$(pgrep -f "rds.py")
              echo "âœ… ğŸ‰ LIVE! PID: $PID"
              echo "ğŸ“‹ Logs:"
              tail -10 backend.log
              echo "ğŸ‰ DEPLOYMENT COMPLETE!"
            else
              echo "âŒ Failed to start"
              tail -20 backend.log || echo "No logs"
              exit 1
            fi
