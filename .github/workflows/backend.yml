name: Backend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend using Bastion (First Time + RDS DB)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_PRIVATE_IP }}
          username: ${{ secrets.BACKEND_USER }}
          key: ${{ secrets.BACKEND_KEY }}

          # Bastion settings
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          
          # Extended timeout for DB import
          timeout: 60m
          script_stop: true

          script: |
            set -e
            echo "üöÄ FIRST TIME Backend + RDS deployment started"

            # Install dependencies (Git + Python tools + MySQL client)
            echo "üì¶ Installing system dependencies..."
            if command -v yum &> /dev/null; then
              sudo yum update -y &>/dev/null
              sudo yum install -y git python3 python3-pip mariadb105 mysql &>/dev/null
            elif command -v apt &> /dev/null; then
              sudo apt update &>/dev/null
              sudo apt install -y git python3 python3-pip python3-venv mariadb-client -y &>/dev/null
            fi
            echo "‚úÖ System dependencies installed"

            # Clone repository (fresh install) - NEW REPO
            echo "üîÑ Cloning VaibhavJC/Paytm-fullstack-project..."
            REPO_DIR="/home/ec2-user/Paytm-fullstack-project"
            rm -rf "$REPO_DIR"  # Clean any partial clone
            git clone https://github.com/VaibhavJC/Paytm-fullstack-project.git "$REPO_DIR"
            cd "$REPO_DIR/Backend"

            # ===== CRITICAL: IMPORT DATABASE SCHEMA TO RDS =====
            echo "‚òÅÔ∏è  Importing paytml.sql to AWS RDS..."
            mysql -h projectdb.c1uy4qas2jj8.ap-south-1.rds.amazonaws.com \
                  -u admin \
                  -pcloud123 \
                  < paytml.sql
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ RDS Database imported successfully!"
            else
              echo "‚ùå RDS import failed!"
              exit 1
            fi

            # Setup Python environment
            echo "üêç Creating Python virtual environment..."
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "‚ñ∂Ô∏è Starting Backend service (with RDS connection)..."
            nohup python rds.py > backend.log 2>&1 < /dev/null &
            sleep 15  # Give Flask + RDS connection time

            # SIMPLE PROCESS CHECK
            if pgrep -f "rds.py" > /dev/null; then
              PID=$(pgrep -f "rds.py")
              echo "‚úÖ Backend started successfully! PID: $PID"
              echo "üìã First 15 lines of logs:"
              tail -15 backend.log || echo "Logs not ready yet"
              echo "üéâ FIRST DEPLOYMENT + RDS DB IMPORT COMPLETED!"
            else
              echo "‚ùå Backend FAILED to start!"
              echo "üìã Check logs:"
              tail -20 backend.log || echo "No logs yet"
              echo "üîç Running processes:"
              ps aux | grep rds.py || echo "No rds.py process found"
              exit 1
            fi
