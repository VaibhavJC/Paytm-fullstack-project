name: Backend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend using Bastion
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_PRIVATE_IP }}
          username: ${{ secrets.BACKEND_USER }}
          key: ${{ secrets.BACKEND_KEY }}

          # Bastion settings
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          
          timeout: 60m
          script_stop: true

          script: |
            set -e
            echo "ğŸš€ Backend deployment started"
          
            # ===== 0. SAFE PROCESS KILL =====
            echo "ğŸ—‘ï¸ Killing existing backend processes..."
            if pgrep -f "rds.py" > /dev/null; then
              echo "ğŸ”ª Found running rds.py process(es), killing gracefully..."
              pkill -f "rds.py" || true
              sleep 3
              pkill -9 -f "rds.py" || true
              echo "âœ… Old backend processes terminated"
            else
              echo "â„¹ï¸ No existing backend process found"
            fi
          
            # ===== 1. SETUP PROJECT =====
            echo "ğŸ”„ Setting up project..."
            REPO_DIR="/home/ec2-user/Paytm-fullstack-project"
            if [ -d "$REPO_DIR" ]; then
              cd "$REPO_DIR"
              git pull origin main || (rm -rf "$REPO_DIR" && git clone https://github.com/VaibhavJC/Paytm-fullstack-project.git "$REPO_DIR")
            else
              git clone https://github.com/VaibhavJC/Paytm-fullstack-project.git "$REPO_DIR"
            fi
            cd "$REPO_DIR/Backend"
          
            # ===== 2. PYTHON ENVIRONMENT =====
            echo "ğŸ Setting up Python environment..."
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt --quiet
          
            # ===== 3. START NEW BACKEND =====
            echo "â–¶ï¸ Starting new Backend service..."
            nohup python rds.py > backend.log 2>&1 < /dev/null &
            NEW_PID=$!
            echo "ğŸ“ Backend PID: $NEW_PID"
            
            # Wait and verify
            sleep 10
            if ps -p $NEW_PID > /dev/null 2>&1 || pgrep -f "rds.py" > /dev/null; then
              echo "âœ… Backend started successfully!"
              echo "ğŸ“‹ Recent logs:"
              tail -15 backend.log || echo "Logs not ready"
              curl -s http://localhost:5000/ > /dev/null && echo "ğŸŒ Local endpoint OK!" || echo "âš ï¸ Endpoint warming up..."
              echo "ğŸ‰ DEPLOYMENT COMPLETED!"
            else
              echo "âŒ Backend startup verification failed"
              tail -20 backend.log
              ps aux | grep rds.py
              exit 1
            fi
