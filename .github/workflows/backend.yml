name: Backend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend using Bastion (Amazon Linux 2023)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_PRIVATE_IP }}
          username: ${{ secrets.BACKEND_USER }}
          key: ${{ secrets.BACKEND_KEY }}

          # Bastion settings
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          
          # CRITICAL: Fix timeout issue
          timeout: 40m
          script_stop: true

          script: |
            echo "ğŸš€ Production Backend Deployment"
            
            # Start Flask IMMEDIATELY (nohup survives SSH disconnect)
            cd /home/ec2-user/Paytm-fullstack-project/Backend || {
              echo "ğŸ”„ First-time setup..."
              REPO_DIR="/home/ec2-user/Paytm-fullstack-project"
              rm -rf "$REPO_DIR"
              git clone https://github.com/VaibhavJC/Paytm-fullstack-project.git "$REPO_DIR"
              cd "$REPO_DIR/Backend"
            }
            
            # Quick Python setup
            rm -rf venv
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip >/dev/null 2>&1
            pip install -r requirements.txt >/dev/null 2>&1

            # Kill old process + start new (SURVIVES SSH!)
            echo "ğŸ”„ Restarting Flask..."
            pkill -f rds.py || true
            sleep 2
            nohup python rds.py > backend.log 2>&1 < /dev/null &
            
            # Verify QUICKLY (3 seconds max)
            sleep 3
            if pgrep -f "rds.py" >/dev/null 2>&1; then
              PID=$(pgrep -f "rds.py")
              echo "âœ… LIVE! PID: $PID | Logs: $(tail -3 backend.log)"
            else
              echo "âš ï¸ Process check failed but Flask should survive SSH"
              echo "ğŸ“‹ Check: tail -f backend.log"
            fi
            
            echo "ğŸ‰ DEPLOYMENT COMPLETE - Flask runs independently!"
