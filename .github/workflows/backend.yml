name: Backend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend using Bastion
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_PRIVATE_IP }}
          username: ${{ secrets.BACKEND_USER }}
          key: ${{ secrets.BACKEND_KEY }}

          # Bastion settings
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          
          timeout: 60m
          script_stop: true

          script: |
            set -e
            echo "ğŸš€ Backend deployment started"

            # ===== 0. KILL EXISTING BACKEND PROCESS (NEW) =====
            echo "ğŸ—‘ï¸ Killing existing backend processes..."
            if pgrep -f "rds.py" > /dev/null; then
              echo "ğŸ”ª Found running rds.py process(es), killing..."
              pkill -f "rds.py" || echo "No rds.py process found"
              sleep 3  # Give time for graceful shutdown
              # Force kill any stubborn processes
              pkill -9 -f "rds.py" || echo "No stubborn processes"
              echo "âœ… Old backend processes terminated"
            else
              echo "â„¹ï¸ No existing backend process found"
            fi

            # ===== 1. INSTALL SYSTEM DEPENDENCIES (if needed) =====
            echo "ğŸ“¦ Checking/Installing system dependencies..."
            if ! command -v python3 &> /dev/null; then
              if command -v yum &> /dev/null; then
                sudo yum update -y &>/dev/null
                sudo yum install -y git python3 python3-pip &>/dev/null
              elif command -v apt &> /dev/null; then
                sudo apt update &>/dev/null
                sudo apt install -y git python3 python3-pip python3-venv &>/dev/null
              fi
            fi
            echo "âœ… Dependencies ready"

            # ===== 2. SETUP PROJECT DIRECTORY =====
            echo "ğŸ”„ Setting up project directory..."
            REPO_DIR="/home/ec2-user/Paytm-fullstack-project"
            cd /home/ec2-user || echo "Directory exists"
            
            # Stopped MariaDB installation since you're using RDS
            # Only clone if directory doesn't exist or force fresh clone
            if [ ! -d "$REPO_DIR" ] || [ -z "$(ls -A "$REPO_DIR")" ]; then
              echo "ğŸ“¥ Cloning fresh repository..."
              rm -rf "$REPO_DIR"
              git clone https://github.com/VaibhavJC/Paytm-fullstack-project.git "$REPO_DIR"
            else
              echo "ğŸ”„ Pulling latest changes..."
              cd "$REPO_DIR"
              git pull origin main
            fi
            cd "$REPO_DIR/Backend"

            # ===== 3. SETUP PYTHON ENVIRONMENT =====
            echo "ğŸ Setting up Python environment..."
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # ===== 4. START BACKEND SERVICE =====
            echo "â–¶ï¸ Starting new Backend service..."
            nohup python rds.py > backend.log 2>&1 < /dev/null &
            NEW_PID=$!
            echo "ğŸ“ Backend PID: $NEW_PID"
            
            # Wait and verify
            sleep 10
            if ps -p $NEW_PID > /dev/null 2>&1; then
              echo "âœ… Backend started successfully! PID: $NEW_PID"
              echo "ğŸ“‹ Recent logs:"
              tail -15 backend.log || echo "Logs not ready yet"
              curl -s http://localhost:5000/ > /dev/null && echo "ğŸŒ Local endpoint responding!" || echo "âš ï¸ Local endpoint not ready yet"
            else
              echo "âŒ Backend FAILED to start!"
              echo "ğŸ“‹ Check logs:"
              tail -20 backend.log || echo "No logs available"
              ps aux | grep rds.py || echo "No rds.py process running"
              exit 1
            fi
            echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
