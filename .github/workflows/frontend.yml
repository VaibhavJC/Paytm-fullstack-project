
name: Frontend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Frontend using Bastion
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_PRIVATE_IP }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_KEY }}

          # Bastion settings (same as backend)
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          
          timeout: 20m
          script_stop: true

          script: |
            echo "ðŸš€ Frontend Deployment Started"

            # 1. Install git & clone repo
            sudo yum install git -y
            cd /home/ec2-user
            rm -rf Paytm-fullstack-project
            git clone https://github.com/VaibhavJC/Paytm-fullstack-project.git
            cd Paytm-fullstack-project/Frontend

            # 2. Frontend-S3 Python backend setup
            echo "ðŸ Setting up Frontend-S3 backend..."
            cd Frontend-S3
            sudo yum update -y
            sudo yum install python3 python3-pip -y
            python3 --version
            pip3 --version
            
            pip install -r requirements.txt

            # 3. Start Frontend-S3 Python service
            echo "â–¶ï¸ Starting backends3.py..."
            pkill -f backends3.py || true
            sleep 2
            nohup python3 backends3.py > backend.log 2>&1 < /dev/null &
            sleep 3
            echo "âœ… Frontend-S3 PID: $(pgrep -f backends3.py || echo 'starting')"

            # 4. Return to home & install Apache
            cd ~
            echo "ðŸŒ Installing Apache httpd..."
            sudo yum update -y
            sudo yum install httpd -y
            sudo systemctl start httpd
            sudo systemctl enable httpd
            echo "âœ… Apache status: $(sudo systemctl is-active httpd)"

            # 5. Copy frontend files to Apache
            echo "ðŸ“ Deploying static files..."
            cd Paytm-fullstack-project/
            sudo cp -r * /var/www/html/
            sudo systemctl restart httpd

            # 6. Final verification
            echo "ðŸ” Verification:"
            echo "Apache: $(sudo systemctl is-active httpd)"
            echo "S3 Backend: $(pgrep -f backends3.py && echo 'RUNNING' || echo 'NOT FOUND')"
            echo "Website: http://$(curl -s ifconfig.me):80"
            echo "ðŸŽ‰ FRONTEND LIVE!"
