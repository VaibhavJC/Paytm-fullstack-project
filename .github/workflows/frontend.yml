name: Frontend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Frontend using Bastion
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_PRIVATE_IP }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_KEY }}
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          timeout: 20m
          script_stop: true

          script: |
            echo "ğŸš€ Frontend + backends3.py (Port 5000)"

            # 1. Clone repo (FIXED URL)
            sudo yum install git -y
            cd /home/ec2-user
            rm -rf Paytm-fullstack-project
            git clone https://github.com/CloudTechDevOps/Paytm-fullstack-project.git Paytm-fullstack-project
            cd Paytm-fullstack-project/Frontend/Frontend-S3

            # 2. Python setup for backends3.py (PORT 5000)
            echo "ğŸ backends3.py setup (port 5000)..."
            sudo yum update -y
            sudo yum install python3 python3-pip -y
            pip3 install -r requirements.txt

            # 3. Start backends3.py on port 5000
            echo "ğŸŒ Starting backends3.py:5000..."
            pkill -f backends3.py || true
            sleep 2
            nohup python3 backends3.py > backend.log 2>&1 < /dev/null &
            sleep 5
            
            # Verify port 5000
            if pgrep -f backends3.py >/dev/null 2>&1 && ss -tlnp | grep :5000; then
              PID=$(pgrep -f backends3.py)
              echo "âœ… backends3.py LIVE! PID: $PID | Port 5000"
              echo "ğŸ“‹ Logs: $(tail -2 backend.log)"
            else
              echo "âš ï¸ backends3.py check:"
              tail -5 backend.log || echo "No logs"
            fi

            # 4. Apache for static frontend
            cd ~
            echo "ğŸŒ Apache setup..."
            sudo yum install httpd -y
            sudo systemctl start httpd
            sudo systemctl enable httpd

            # 5. Deploy static files (FIXED path)
            cd /home/ec2-user/Paytm-fullstack-project/
            sudo rm -rf /var/www/html/*
            sudo cp -r Frontend/* /var/www/html/ || sudo cp -r * /var/www/html/
            sudo systemctl restart httpd
            sudo chown -R apache:apache /var/www/html

            echo "ğŸ‰ FRONTEND LIVE!"
            echo "ğŸŒ Static: http://$(curl -s ifconfig.me)"
            echo "ğŸŒ API:    http://$(curl -s ifconfig.me):5000"
