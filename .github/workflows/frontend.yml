name: Frontend CI/CD (Private via Bastion)

on:
  push:
    branches: ["main"]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Frontend using Bastion
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_PRIVATE_IP }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_KEY }}
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_KEY }}
          timeout: 20m
          script_stop: true

          script: |
            echo "ğŸš€ Frontend Deployment (httpd FIRST)"

            # 1. Install git & clone repo
            sudo yum install git -y
            cd /home/ec2-user
            rm -rf Paytm-fullstack-project
            git clone https://github.com/CloudTechDevOps/Paytm-fullstack-project.git Paytm-fullstack-project

            # ===== HTTPD TASKS FIRST =====
            echo "ğŸŒ Setting up Apache httpd..."
            sudo yum update -y
            sudo yum install httpd -y
            sudo systemctl start httpd
            sudo systemctl enable httpd
            echo "âœ… Apache: $(sudo systemctl is-active httpd)"

            # Deploy static frontend files
            echo "ğŸ“ Deploying static files to Apache..."
            cd /home/ec2-user/Paytm-fullstack-project
            sudo rm -rf /var/www/html/*
            sudo cp -r Frontend/* /var/www/html/
            sudo chown -R apache:apache /var/www/html
            sudo systemctl restart httpd
            echo "âœ… Static site: http://$(curl -s ifconfig.me)"

            # ===== NOW backends3.py (PORT 5000) - FIXED PATH =====
            echo "ğŸ backends3.py setup (port 5000)..."
            cd /home/ec2-user/Paytm-fullstack-project/Frontend/Frontend-S3
            sudo yum install python3 python3-pip -y
            pip3 install -r requirements.txt

            echo "ğŸŒ Starting backends3.py:5000..."
            pkill -f backends3.py || true
            sleep 2
            nohup python3 backends3.py > backend.log 2>&1 < /dev/null &
            sleep 5
            
            # Verify port 5000
            if pgrep -f backends3.py >/dev/null 2>&1 && ss -tlnp | grep :5000; then
              PID=$(pgrep -f backends3.py)
              echo "âœ… backends3.py LIVE! PID: $PID | Port 5000"
              echo "ğŸ“‹ Logs: $(tail -2 backend.log)"
            else
              echo "âš ï¸ backends3.py check:"
              tail -5 backend.log || echo "No logs"
            fi

            echo "ğŸ‰ FRONTEND COMPLETE!"
            echo "ğŸŒ Static: http://$(curl -s ifconfig.me)"
            echo "ğŸŒ API:    http://$(curl -s ifconfig.me):5000"
